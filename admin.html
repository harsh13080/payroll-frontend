<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f4f6f9; }
    .navbar { background: linear-gradient(90deg, #ff512f, #dd2476); }
    .card { border-radius: 12px; box-shadow: 0px 4px 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-dark px-3">
    <span class="navbar-brand">Admin Dashboard</span>
    <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
  </nav>

  <div class="container mt-4">
    <div class="row g-4">
      
      <!-- Salary Slip Generate -->
      <div class="col-md-6">
        <div class="card p-3">
          <h5>Generate Salary Slip</h5>
          <form id="salaryForm">
            <input type="text" id="employeeId" class="form-control mb-2" placeholder="Employee ID" required>
            <input type="number" id="basic" class="form-control mb-2" placeholder="Basic Salary" required>
            <input type="number" id="allowances" class="form-control mb-2" placeholder="Allowances">
            <input type="number" id="deductions" class="form-control mb-2" placeholder="Deductions">
            <input type="month" id="month" class="form-control mb-2" required>
            <button type="submit" class="btn btn-primary w-100">Generate</button>
          </form>
        </div>
      </div>

      <!-- Salary Slips -->
      <div class="col-md-6">
        <div class="card p-3">
          <h5>All Salary Slips</h5>
          <ul id="salaryList" class="list-group mt-2"></ul>
        </div>
      </div>

      <!-- Expenses -->
      <div class="col-md-6">
        <div class="card p-3">
          <h5>Employee Expenses</h5>
          <ul id="expenseList" class="list-group mt-2"></ul>
        </div>
      </div>

      <!-- Charts -->
      <div class="col-md-6">
        <div class="card p-3">
          <h5>Payroll & Expenses Overview</h5>
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));

    if (!token || !user || user.role !== "admin") {
      alert("Unauthorized! Please login as Admin.");
      window.location.href = "index.html";
    }

    // Generate salary slip
    document.getElementById("salaryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const employeeId = document.getElementById("employeeId").value;
      const basic = document.getElementById("basic").value;
      const allowances = document.getElementById("allowances").value || 0;
      const deductions = document.getElementById("deductions").value || 0;
      const month = document.getElementById("month").value;

      const res = await fetch("https://payroll-backend-yw3u.onrender.com/api/salaries", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token 
        },
        body: JSON.stringify({ employeeId, basic, allowances, deductions, month })
      });
      if (res.ok) {
        alert("Salary slip generated!");
        loadSalaries();
        loadChart();
        document.getElementById("salaryForm").reset();
      }
    });

    // Load all salaries
    async function loadSalaries() {
      const res = await fetch("https://payroll-backend-yw3u.onrender.com/api/salaries", {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      const list = document.getElementById("salaryList");
      list.innerHTML = "";
      data.forEach(slip => {
        list.innerHTML += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${slip.employee?.name} (${slip.month}) - <strong>₹${slip.netPay}</strong></span>
            <div>
              <button class="btn btn-sm btn-warning" onclick="editSalary('${slip._id}', ${slip.basic}, ${slip.allowances}, ${slip.deductions}, '${slip.month}')">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteSalary('${slip._id}')">Delete</button>
            </div>
          </li>`;
      });
    }

    // Edit Salary Slip
    async function editSalary(id, basic, allowances, deductions, month) {
      const newBasic = prompt("Enter Basic Salary", basic);
      const newAllowances = prompt("Enter Allowances", allowances);
      const newDeductions = prompt("Enter Deductions", deductions);
      const newMonth = prompt("Enter Month (YYYY-MM)", month);

      if (!newBasic || !newMonth) return alert("Basic salary and month required!");

      const res = await fetch("https://payroll-backend-yw3u.onrender.com/api/salaries/" + id, {
        method: "PUT",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token 
        },
        body: JSON.stringify({ basic: newBasic, allowances: newAllowances, deductions: newDeductions, month: newMonth })
      });

      if (res.ok) {
        alert("Salary slip updated!");
        loadSalaries();
        loadChart();
      } else {
        alert("Error updating salary slip");
      }
    }

    // Delete Salary Slip
    async function deleteSalary(id) {
      if (!confirm("Are you sure you want to delete this salary slip?")) return;

      const res = await fetch("https://payroll-backend-yw3u.onrender.com/api/salaries/" + id, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });

      if (res.ok) {
        alert("Salary slip deleted!");
        loadSalaries();
        loadChart();
      } else {
        alert("Error deleting salary slip");
      }
    }

    // Load all expenses
    async function loadExpenses() {
      const res = await fetch("https://payroll-backend-yw3u.onrender.com/api/expenses", {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      const list = document.getElementById("expenseList");
      list.innerHTML = "";
      data.forEach(exp => {
        list.innerHTML += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${exp.employee?.name} - ${exp.month} - ₹${exp.amount}</span>
            <div>
              <button class="btn btn-sm btn-success" onclick="updateExpense('${exp._id}', 'approved')">Approve</button>
              <button class="btn btn-sm btn-danger" onclick="updateExpense('${exp._id}', 'rejected')">Reject</button>
            </div>
          </li>`;
      });
    }

    // Update expense status
    async function updateExpense(id, status) {
      const res = await fetch("https://payroll-backend-yw3u.onrender.com/api/expenses/" + id, {
        method: "PUT",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token 
        },
        body: JSON.stringify({ status })
      });
      if (res.ok) {
        alert("Expense " + status);
        loadExpenses();
      }
    }

    // Load chart
    async function loadChart() {
      const res = await fetch("https://payroll-backend-yw3u.onrender.com/api/dashboard/stats", {
        headers: { "Authorization": "Bearer " + token }
      });
      const { payroll, expenses } = await res.json();

      const ctx = document.getElementById("chart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: payroll.map(p => p._id),
          datasets: [
            { label: "Payroll", data: payroll.map(p => p.totalPayroll), backgroundColor: "blue" },
            { label: "Expenses", data: expenses.map(e => e.totalExpenses), backgroundColor: "red" }
          ]
        }
      });
    }

    function logout() {
      const confirmLogout = confirm("Are you sure you want to logout?");
      if (confirmLogout) {
        localStorage.clear();
        window.location.href = "index.html";
      }
    }

    // Init
    loadSalaries();
    loadExpenses();
    loadChart();
  </script>
</body>
</html>
